<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR-сканер с автосбросом</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    .wrap { position: relative; display: inline-block; }
    #video { width: 100%; max-width: 480px; border-radius: 12px; }
    #overlay { position: absolute; inset: 0; pointer-events: none; }
    #result { margin-top: 16px; font-size: 16px; }
    #countdown { opacity: .7; font-size: 14px; }
    button { margin-top: 12px; padding: 8px 12px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>Сканируем QR</h1>

  <div class="wrap">
    <video id="video" muted playsinline></video>
    <div id="overlay"></div>
  </div>

  <div id="result">Наведите камеру на QR-код…</div>
  <div id="countdown"></div>
  <button id="resetBtn" type="button">Очистить сейчас</button>
  <div id="result"></div>

  <script type="module">
    import QrScanner from './qr-scanner.min.js'; // положи рядом
    // рядом же должен лежать qr-scanner-worker.min.js

    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const resultEl = document.getElementById('result');
    const countdownEl = document.getElementById('countdown');
    const resetBtn = document.getElementById('resetBtn');

    let processing = false;      // чтобы не ловить дубликаты
    let timerId = null;          // таймер на автосброс
    let countdownId = null;      // таймер на цифирки

    const qrScanner = new QrScanner(
      video,
      onDecode,
      {
        preferredCamera: 'environment',
        highlightScanRegion: true,
        highlightCodeOutline: true,
        overlay,
        returnDetailedScanResult: true
      }
    );

    start();

    async function start() {
      try {
        await qrScanner.start();
        resultEl.textContent = 'Камера запущена. Наведите на QR-код.';
        countdownEl.textContent = '';
      } catch (e) {
        resultEl.textContent = 'Не удалось открыть камеру: ' + (e?.message || e);
      }
    }

    function onDecode(decoded) {
      if (processing) return;          // защита от многократных срабатываний
      processing = true;

      const text = typeof decoded === 'string' ? decoded : decoded.data;

      // стопаем сканер, чтобы не наштамповало одинаковых результатов
      qrScanner.stop(); // потом просто вызовем start() заново через 5 секунд

      // выводим результат
      let url;
      try { url = new URL(text); } catch {}
      if (url && (url.protocol === 'http:' || url.protocol === 'https:')) {
        resultEl.innerHTML = `Найдено: <a href="${url.href}" target="_blank" rel="noopener noreferrer">${url.href}</a>`;
        //!!!!!!!!! Тут сделать запрос на сервак
        fetch(`http://192.168.50.183:80/run-parsing-check?invoice_link=${encodeURIComponent(url.href)}`, {
                method: 'GET',
                // headers: {
                //     'invoice-link': encodeURIComponent(decodedText)
                // }
            })
            .then(response => {
                switch (response.status) {
                    case 200:
                        document.getElementById('result').innerHTML += `<div style="color:green;">Success</div>`;
                        break;
                    default:
                        document.getElementById('result').innerHTML += `<div style="color:red;">Failed</div>`;
                        break;
                }
                return response.text();
            })

      } else {
        resultEl.textContent = 'Найдено: ' + text;
      }

      // запускаем обратный отсчёт и автосброс
      startCountdownAndReset(2);
    }

    function startCountdownAndReset(seconds) {
      // чистим предыдущие таймеры на всякий
      clearTimeout(timerId);
      clearInterval(countdownId);

      let left = seconds;
      countdownEl.textContent = `Сканер перезапустится через ${left} сек.`;
      countdownId = setInterval(() => {
        left -= 1;
        if (left <= 0) {
          clearInterval(countdownId);
          countdownEl.textContent = '';
        } else {
          countdownEl.textContent = `Сканер перезапустится через ${left} сек.`;
        }
      }, 1000);

      timerId = setTimeout(async () => {
        // очищаем вывод
        resultEl.textContent = 'Готово. Наведите на следующий QR-код…';
        processing = false;
        try {
          await qrScanner.start(); // обычный «ресюм» через start()
        } catch (e) {
          resultEl.textContent = 'Не удалось перезапустить сканер: ' + (e?.message || e);
        }
      }, seconds * 1000);
    }

    // Кнопка для ручного сброса без ожидания 5 сек
    resetBtn.addEventListener('click', async () => {
      clearTimeout(timerId);
      clearInterval(countdownId);
      countdownEl.textContent = '';
      resultEl.textContent = 'Готово. Наведите на следующий QR-код…';
      processing = false;
      try { await qrScanner.start(); } catch (e) {
        resultEl.textContent = 'Не удалось перезапустить сканер: ' + (e?.message || e);
      }
    });

    // На всякий случай выключим сканер при уходе со страницы
    window.addEventListener('pagehide', () => qrScanner.stop());
  </script>
</body>
</html>
